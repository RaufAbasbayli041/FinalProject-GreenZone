# Диагностика проблемы с токеном

## Проблема
Токен есть в API, но не находится в frontend при запросах к basket API.

## Возможные причины

### 1. **Токен не сохраняется в localStorage**
- Проверить процесс логина
- Убедиться, что токен сохраняется после успешной авторизации

### 2. **Токен удаляется или перезаписывается**
- Проверить, не удаляется ли токен другими частями кода
- Убедиться, что нет конфликтов при сохранении

### 3. **Проблемы с SSR (Server-Side Rendering)**
- Токен недоступен на сервере
- Проверить условия `typeof window !== 'undefined'`

### 4. **Проблемы с CORS или сетью**
- API недоступен
- Неправильные заголовки запроса

## Диагностические шаги

### Шаг 1: Проверить токен в localStorage
```javascript
// В консоли браузера:
console.log('localStorage keys:', Object.keys(localStorage));
console.log('auth_token:', localStorage.getItem('auth_token'));
```

### Шаг 2: Проверить процесс логина
1. Открыть DevTools → Network
2. Выполнить логин
3. Проверить ответ от `/api/Auth/login`
4. Убедиться, что токен сохраняется в localStorage

### Шаг 3: Проверить запросы к basket API
1. Открыть DevTools → Network
2. Перейти на страницу корзины
3. Проверить заголовки запроса к `/api/Basket/{customerId}`
4. Убедиться, что заголовок `Authorization: Bearer {token}` присутствует

### Шаг 4: Использовать диагностические скрипты
```javascript
// Загрузить и запустить диагностику:
// 1. token-diagnostics.js - проверка токена
// 2. api-token-test.js - тест API с токеном
```

## Решения

### Решение 1: Улучшенное логирование
Добавлено детальное логирование в:
- `services/basket-api.ts` - функция `getAuthToken()` и `fetchJSON()`
- `contexts/auth-context.tsx` - функция `getAuthToken()`

### Решение 2: Проверка сохранения токена
Убедиться, что токен сохраняется в двух местах:
- `services/auth-api.ts` - после успешного логина
- `contexts/auth-context.tsx` - в функции `login()`

### Решение 3: Проверка условий SSR
Все функции получения токена проверяют:
```typescript
if (typeof window === 'undefined') {
  console.log('getAuthToken: window is undefined (SSR)')
  return null
}
```

## Тестирование

### Автоматические тесты
```javascript
// В консоли браузера:
tokenDiagnostics.checkToken()        // Проверить токен
apiTest.testAPIWithToken()           // Тест API
apiTest.checkNetworkConnectivity()   // Проверка сети
```

### Ручное тестирование
1. **Очистить localStorage**: `localStorage.clear()`
2. **Выполнить логин** через форму
3. **Проверить токен**: `localStorage.getItem('auth_token')`
4. **Перейти в корзину** и проверить Network tab
5. **Проверить заголовки** запроса к basket API

## Ожидаемое поведение

### При успешном логине:
```
✅ Токен получен от API
✅ Токен сохранен в localStorage
✅ Токен передается в заголовках запросов
✅ API возвращает данные корзины
```

### При проблемах:
```
❌ Токен не найден в localStorage
❌ Заголовок Authorization отсутствует
❌ API возвращает 401 Unauthorized
❌ Корзина не загружается
```

## Дополнительная диагностика

### Проверить консоль браузера
Искать сообщения:
- `getAuthToken: получение токена из localStorage`
- `fetchJSON: начало запроса`
- `fetchJSON: запрос к бэкенду`

### Проверить Network tab
1. Фильтр по `Basket`
2. Проверить заголовки запроса
3. Проверить статус ответа
4. Проверить тело ответа

### Проверить Application tab
1. Local Storage
2. Ключ `auth_token`
3. Значение токена

## Заключение

Проблема скорее всего в одном из следующих:
1. **Токен не сохраняется** после логина
2. **Токен удаляется** до запроса к basket API
3. **Проблемы с SSR** - токен недоступен на сервере
4. **API недоступен** или возвращает ошибки

Используйте диагностические скрипты и проверьте консоль браузера для точного определения причины.
